<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <system.webServer>
        <!-- ARR Configuration -->
        <webFarms>
            <webFarm name="PRASBackend" enabled="true">
                <server address="127.0.0.1" enabled="true">
                    <applicationRequestRouting>
                        <healthCheck url="http://127.0.0.1:5004/health" interval="00:00:30" />
                    </applicationRequestRouting>
                </server>
                <applicationRequestRouting>
                    <affinity useCookie="false" />
                    <protocol reverseRewriteHostInResponseHeaders="false" />
                    <webSocket enabled="true" />
                </applicationRequestRouting>
            </webFarm>
        </webFarms>
        
        <rewrite>
            <rules>
                <!-- WebSocket proxy rule using ARR - must come before API proxy -->
                <rule name="WebSocket Proxy ARR" stopProcessing="true">
                    <match url="^communicate$" />
                    <conditions logicalGrouping="MatchAny">
                        <add input="{HTTP_UPGRADE}" pattern="websocket" />
                        <add input="{HTTP_CONNECTION}" pattern="upgrade" />
                    </conditions>
                    <action type="Rewrite" url="http://PRASBackend/communicate" />
                    <serverVariables>
                        <set name="HTTP_X_ORIGINAL_URL" value="/communicate" />
                        <set name="HTTP_X_FORWARDED_FOR" value="{REMOTE_ADDR}:{REMOTE_PORT}" />
                        <set name="HTTP_X_FORWARDED_PROTO" value="https" />
                        <set name="HTTP_X_FORWARDED_HOST" value="{HTTP_HOST}" />
                        <set name="HTTP_X_FORWARDED_SSL" value="on" />
                    </serverVariables>
                </rule>
                
                <!-- API proxy rule using ARR -->
                <rule name="API Proxy ARR" stopProcessing="true">
                    <match url="^api/(.*)$" />
                    <action type="Rewrite" url="http://PRASBackend/api/{R:1}" />
                </rule>
                
                <!-- Health check proxy -->
                <rule name="Health Check Proxy" stopProcessing="true">
                    <match url="^health$" />
                    <action type="Rewrite" url="http://PRASBackend/health" />
                </rule>
                
                <!-- SPA fallback - serve index.html for all other routes -->
                <rule name="SPA Fallback" stopProcessing="true">
                    <match url=".*" />
                    <conditions logicalGrouping="MatchAll">
                        <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
                        <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
                        <add input="{REQUEST_URI}" pattern="^/(api|communicate|health)" negate="true" />
                    </conditions>
                    <action type="Rewrite" url="/" />
                </rule>
            </rules>
        </rewrite>
        
        <!-- Enable WebSocket protocol -->
        <webSocket enabled="true" />
        
        <!-- WebSocket timeout settings -->
        <applicationInitialization doAppInitAfterRestart="true">
            <add initializationPage="/health" />
        </applicationInitialization>
        

        
        <!-- Security headers -->
        <httpProtocol>
            <customHeaders>
                <add name="X-Content-Type-Options" value="nosniff" />
                <add name="X-Frame-Options" value="DENY" />
                <add name="X-XSS-Protection" value="1; mode=block" />
            </customHeaders>
        </httpProtocol>
    </system.webServer>
    
    <!-- WebSocket specific location configuration -->
    <location path="communicate">
        <system.webServer>
            <security>
                <authentication>
                    <anonymousAuthentication enabled="true" />
                </authentication>
                <authorization>
                    <clear />
                    <add accessType="Allow" users="*" />
                </authorization>
            </security>
            <handlers>
                <remove name="WebSocket" />
            </handlers>
            <modules>
                <remove name="WebSocketModule" />
            </modules>
        </system.webServer>
    </location>
</configuration>
